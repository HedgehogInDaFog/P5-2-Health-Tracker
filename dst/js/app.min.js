"use strict";var app=app||{};app.Food=Backbone.Model.extend({defaults:{name:"",calories:0,quantity:0}}),app.Search=Backbone.Model.extend({defaults:{name:"",calories:0}}),app.Stat=Backbone.Model.extend({defaults:{name:"",calories:0,date:"",id:""}});var app=app||{};app.FoodList=Backbone.Collection.extend({model:app.Food,initialize:function(t,e){this.date=e.date,this.localStorage=new Backbone.LocalStorage("foodList-"+this.date)},totalCalories:function(){for(var t=0,e=this.models.length,i=0;e>i;i++)t+=this.models[i].get("calories")*this.models[i].get("quantity"),t=Math.round(t);return t}}),app.SearchList=Backbone.Collection.extend({model:app.Search}),app.StatList=Backbone.Collection.extend({model:app.Stat});var app=app||{};app.AppView=Backbone.View.extend({el:"body",template:_.template($("#loadingFailedTemplate").html()),templateLoading:_.template($("#loadingIndicator").html()),events:{"click .search-button":"searchItem","click .add-manually-button":"addManually","keyup .search-string":"keyPressSearch","keyup .food-name-input":"keyPressAdd","keyup .food-kcal-input":"keyPressAdd"},initialize:function(){this.$foodNameString=$(".food-name-input"),this.$foodKcalString=$(".food-kcal-input"),this.$searchString=$(".search-string"),this.$searchView=$(".search-view"),this.$statView=$(".statistics-view"),this.dateView=new app.DateView,this.foodCollections={},this.foodCollections[this.dateView.getDate()]=new app.FoodList([],{date:this.dateView.getDate()}),this.foodListView=new app.FoodListView({collection:this.foodCollections[this.dateView.getDate()]}),this.searchListView=new app.SearchListView({collection:new app.SearchList}),this.statListView=new app.StatListView({collection:this.initStatCollection()}),this.foodListView.collection.fetch(),this.counter=new app.CounterView({collection:this.foodListView.collection}),this.listenTo(this.searchListView,"addItem",this.addItem),this.listenTo(this.dateView,"changeDate",this.changeCurrentCollection),this.listenTo(this.foodListView,"countStats",this.countStats),this.countStats(),self=this},addItem:function(t){this.$searchString.val(""),this.foodListView.addItem(new app.Food({name:t.name,calories:t.calories,quantity:1})),self.countStats()},addManually:function(){this.foodListView.addItem(new app.Food({name:this.$foodNameString.val(),calories:this.$foodKcalString.val(),quantity:1})),this.$foodNameString.val(""),this.$foodKcalString.val(""),self.countStats()},changeCurrentCollection:function(t){var e=this.getCollectionByDate(t);this.foodListView.changeCurrentCollection(e),this.counter.changeCurrentCollection(e)},countStats:function(){for(var t,e,i=new Date,a=new Date,n=0,o="-",s=1e6,l="-",c=0,d=0,r=0,h=0;30>h;h++)a.setDate(i.getDate()-h),t=this.getCollectionByDate(this.dateView.dateToString(a)),t.fetch(),e=t.totalCalories(),e>0&&(d+=1,c+=e,e>n&&(n=e,o=this.dateView.dateToString(a)),s>e&&(s=e,l=this.dateView.dateToString(a)));return r=Math.round(c/d),1e6===s&&(s=0),this.statListView.collection.models.forEach(function(t){"max30"===t.get("id")&&(t.set("date",o),t.set("calories",n)),"min30"===t.get("id")&&(t.set("date",l),t.set("calories",s)),"avr"===t.get("id")&&t.set("calories",r)}),!0},getCollectionByDate:function(t){return this.foodCollections[t]||(this.foodCollections[t]=new app.FoodList([],{date:t})),this.foodCollections[t]},initStatCollection:function(){var t=[];t.push(new app.Stat({name:"Max per day",calories:0,date:"",id:"max30"})),t.push(new app.Stat({name:"Min per day",calories:0,date:"",id:"min30"})),t.push(new app.Stat({name:"Average per day",calories:0,date:"N/A",id:"avr"}));var e=new app.StatList;return e.add(t),e},keyPressAdd:function(t){13===t.keyCode&&self.addManually()},keyPressSearch:function(t){13===t.keyCode&&self.searchItem()},searchItem:function(){var t="https://api.nutritionix.com/v1_1/search/%SEARCH%?fields=item_name%2Cnf_calories&appId=1c120cc3&appKey=99dd94d4da2652a426b99bbfb4c3da6c",e=this.$searchString.val(),i=t.replace("%SEARCH%",e);self.searchListView.collection.reset(),self.$searchView.html(self.templateLoading);var a=setTimeout(function(){self.$searchView.html(self.template)},8e3);$.ajax({url:i,success:function(t){if(clearTimeout(a),t.total_hits>0)for(var e=t.hits,i=e.length,n=0;i>n;n++)self.searchListView.collection.add(new app.Search({name:e[n].fields.item_name,calories:Math.round(e[n].fields.nf_calories)}))},error:function(){clearTimeout(a),self.$searchView.html(self.template)}})}});var app=app||{};app.CounterView=Backbone.View.extend({el:".counter",initialize:function(){this.render(),this.listenTo(this.collection,"all",this.render)},render:function(){return this.collection?this.$el.html(this.collection.totalCalories()):this.$el.html("0"),this},changeCurrentCollection:function(t){this.collection=t,this.listenTo(this.collection,"all",this.render),this.render()}});var app=app||{};app.DateView=Backbone.View.extend({el:".date-view",events:{"click .day-fw":function(){this.addDays(1)},"click .week-fw":function(){this.addDays(7)},"click .day-back":function(){this.addDays(-1)},"click .week-back":function(){this.addDays(-7)}},initialize:function(){this.$dateField=$(".date-field"),this.date=new Date,this.$dateField.append(this.dateToString(this.date))},render:function(){this.$dateField.text(this.dateToString(this.date))},addDays:function(t){this.date.setDate(this.date.getDate()+t),this.render(),this.trigger("changeDate",this.getDate())},dateToString:function(t){return t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()},getDate:function(){return this.dateToString(this.date)}});var app=app||{};app.FoodView=Backbone.View.extend({tagName:"div",template:_.template($("#foodItemTemplate").html()),events:{"click .clear-button":"removeItem","click .qnt-incr":"incrementQnt","click .qnt-decr":"decrementQnt"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},decrementQnt:function(){this.model.attributes.quantity>0&&(this.model.attributes.quantity-=1,this.model.save(),this.model.collection.trigger(),this.trigger("countStats"))},incrementQnt:function(){this.model.attributes.quantity+=1,this.model.save(),this.model.collection.trigger(),this.trigger("countStats")},removeItem:function(){this.model.destroy(),this.trigger("countStats")}}),app.FoodListView=Backbone.View.extend({el:".eated-food-view",initialize:function(){this.render(),this.listenTo(this.collection,"all",this.render)},render:function(){return this.$el.empty(),this.collection&&this.collection.each(function(t){var e=new app.FoodView({model:t});this.listenTo(e,"countStats",this.triggerCountStats),this.$el.append(e.render().el)},this),this},addItem:function(t){this.collection.add(t),t.save()},changeCurrentCollection:function(t){this.collection=t,this.collection.fetch(),this.listenTo(this.collection,"all",this.render),this.render()},triggerCountStats:function(){this.trigger("countStats")}});var app=app||{};app.SearchView=Backbone.View.extend({tagName:"div",template:_.template($("#searchItemTemplate").html()),events:{"click .add-button":"addItem"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},addItem:function(){this.trigger("addItem",this.model.attributes),this.model.destroy()}}),app.SearchListView=Backbone.View.extend({el:".search-view",initialize:function(){this.render(),this.listenTo(this.collection,"all",this.render)},render:function(){return this.$el.empty(),this.collection.each(function(t){var e=new app.SearchView({model:t});this.listenTo(e,"addItem",this.addItem),this.$el.append(e.render().el)},this),this},addItem:function(t){this.trigger("addItem",t)}});var app=app||{};app.StatView=Backbone.View.extend({tagName:"div",template:_.template($("#statisticsTemplate").html()),initialize:function(){this.listenTo(this.model,"all",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),app.StatListView=Backbone.View.extend({el:".statistics-view",initialize:function(){this.render(),this.listenTo(this.collection,"all",this.render)},render:function(){return this.$el.empty(),this.collection&&this.collection.each(function(t){var e=new app.StatView({model:t});this.$el.append(e.render().el)},this),this}});var app=app||{};app.view=new app.AppView;